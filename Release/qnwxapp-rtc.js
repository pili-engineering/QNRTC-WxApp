module.exports=function(e){var t={};function s(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,s),i.l=!0,i.exports}return s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(r,i,function(t){return e[t]}.bind(null,i));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=15)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNPublishStatus=t.QNConnectionDisconnectedReason=t.QNConnectionState=t.QNLogLevel=t.QNRenderMode=t.QNMediaType=void 0,function(e){e.audio="audio",e.video="video"}(t.QNMediaType||(t.QNMediaType={})),function(e){e.FILL="scaleToFit",e.ASPECT_FILL="aspectFill",e.ASPECT_FIT="aspectFit"}(t.QNRenderMode||(t.QNRenderMode={})),function(e){e.VERBOSE="VERBOSE",e.INFO="INFO",e.WARNING="WARNING",e.ERROR="ERROR",e.NONE="NONE"}(t.QNLogLevel||(t.QNLogLevel={})),function(e){e.DISCONNECTED="DISCONNECTED",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.RECONNECTING="RECONNECTING",e.RECONNECTED="RECONNECTED"}(t.QNConnectionState||(t.QNConnectionState={})),function(e){e.LEAVE="LEAVE",e.KICKED_OUT="KICKED_OUT",e.ERROR="ERROR"}(t.QNConnectionDisconnectedReason||(t.QNConnectionDisconnectedReason={})),function(e){e.READY="READY",e.COMPLATED="COMPLATED",e.ERROR="ERROR"}(t.QNPublishStatus||(t.QNPublishStatus={}))},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ERROR_INVALID_PARAMETER=t.JOIN_ROOM_ERROR=t.SERVER_ERROR=t.ERROR_FATAL=t.ERROR_NETWORK_TIMEOUT=t.ERROR_RECONNECT_FAILED=t.ERROR_INVALID_STATE=t.ERROR_AUTH_FAILED=t.QNRTCError=void 0;const o=n(s(2));class a extends Error{constructor(e,t){super(t),this.code=e,this.error=t,o.default.addEvent(o.QosEventType.SDKError,{error_code:e,error_msg:t})}}t.QNRTCError=a;t.ERROR_AUTH_FAILED=e=>{new a(21001,"error connect websocket "+e)};t.ERROR_INVALID_STATE=()=>new a(21002,"error invalid state");t.ERROR_RECONNECT_FAILED=()=>new a(21003,"websocket reconnectTimes run out, reconnect stops");t.ERROR_NETWORK_TIMEOUT=()=>new a(21004,"error network timeout");t.ERROR_FATAL=e=>new a(21005,"unexpected error "+e);t.SERVER_ERROR=(e,t)=>new a(e,t);t.JOIN_ROOM_ERROR=(e,t)=>new a(e,t);t.ERROR_INVALID_PARAMETER=e=>new a(10053,e)},function(e,t,s){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Qos=t.QosEventType=void 0;const i=r(s(17)),n=r(s(18)),o=r(s(19)),a=s(11),c=s(20),u=s(4),d=s(5),l=s(3);var h;!function(e){e[e.Init=1]="Init",e[e.UnInit=2]="UnInit",e[e.JoinRoom=3]="JoinRoom",e[e.MCSAuth=4]="MCSAuth",e[e.SignalAuth=5]="SignalAuth",e[e.LeaveRoom=6]="LeaveRoom",e[e.PublisherPC=7]="PublisherPC",e[e.PublishTracks=8]="PublishTracks",e[e.UnPublishTracks=9]="UnPublishTracks",e[e.SubscriberPC=10]="SubscriberPC",e[e.SubscribeTracks=11]="SubscribeTracks",e[e.UnSubscribeTracks=12]="UnSubscribeTracks",e[e.MuteTracks=13]="MuteTracks",e[e.ICEConnectionState=14]="ICEConnectionState",e[e.CallbackStatistics=15]="CallbackStatistics",e[e.KickoutUser=16]="KickoutUser",e[e.RoomStateChanged=17]="RoomStateChanged",e[e.AudioDeviceInOut=18]="AudioDeviceInOut",e[e.VideoDeviceInOut=19]="VideoDeviceInOut",e[e.SDKError=20]="SDKError",e[e.ApplicationState=21]="ApplicationState",e[e.CreateMergeJob=22]="CreateMergeJob",e[e.UpdateMergeTracks=23]="UpdateMergeTracks",e[e.StopMerge=24]="StopMerge",e[e.DeviceChanged=25]="DeviceChanged",e[e.DefaultSetting=26]="DefaultSetting",e[e.MediaStatistics=27]="MediaStatistics",e[e.AbnormalDisconnect=28]="AbnormalDisconnect",e[e.WechatPlayerStatus=29]="WechatPlayerStatus",e[e.WechatPlayerStatistics=30]="WechatPlayerStatistics",e[e.WechatPusherStatus=31]="WechatPusherStatus",e[e.WechatPusherStatistics=32]="WechatPusherStatistics",e[e.CreateForwardJob=33]="CreateForwardJob",e[e.StopForwardJob=34]="StopForwardJob"}(h=t.QosEventType||(t.QosEventType={}));class g{constructor(){this.events=[],this.sessionId="",this.rpcId="",this.userBase={user_id:"",room_name:"",app_id:""};const e=wx.getSystemInfoSync();l.logger.log("weappInfo",e),this.base={qos_version:d.QOS_VERSION,device_id:d.DEVICE_ID,bundle_id:"",app_version:e.version,sdk_version:d.VERSION,device_model:e.model,os_platform:e.platform,os_version:e.system,app_sdkVersion:e.SDKVersion},this.lastSubmitTime=Date.now(),this.recoverStoredEvents()}getDeviceId(){return new Promise(e=>{window&&window.requestIdleCallback?window.requestIdleCallback(()=>{i.default.get(t=>{const s=(0,n.default)(JSON.stringify(t));e(s)})}):setTimeout(()=>{i.default.get(t=>{const s=(0,n.default)(JSON.stringify(t));e(s)})},500)})}setSessionId(e){for(let t=this.events.length-1;t>=0;--t){const s=this.events[t];s.session_id||(s.session_id=e)}this.sessionId=e}setRpcId(e){this.rpcId=e}setUserBase(e,t,s){this.userBase={user_id:e,room_name:t,app_id:s};for(let e=this.events.length-1;e>=0;--e){const t=this.events[e];t.user_base||(t.user_base=this.userBase)}}addEvent(e,t,s=!1){const r={timestamp:Date.now(),event_id:e,event_name:h[e],...t};this.events.push({user_base:this.userBase,event:r,session_id:this.sessionId,rpc_id:this.rpcId}),this.submit(s)}recoverStoredEvents(){let e="";try{e=wx.getStorageSync(d.QNRTC_EVENTS_STORATE_KEY)}catch(e){l.logger.warning("get storage error",e)}l.logger.log("get item",e);try{wx.removeStorageSync(d.QNRTC_EVENTS_STORATE_KEY)}catch(e){l.logger.warning("remove storage error",e)}if(!e)return;let t=JSON.parse(decodeURIComponent(a.Base64.atob(e)));t=(t||[]).filter(e=>!!e.session_id&&!!e.user_base).sort((e,t)=>e.event.timestamp-t.event.timestamp),t&&(this.events=t)}saveEvents(){const e=a.Base64.btoa(encodeURIComponent(JSON.stringify(this.events)));try{wx.setStorageSync(d.QNRTC_EVENTS_STORATE_KEY,e)}catch(e){l.logger.warning("storage error",e)}}submit(e=!1){if(e||this.submitCheck())try{const e=this.encodeQosSubmitData().map(e=>(0,u.request)("https://pili-rtc-qos.qiniuapi.com/v1/rtcevent",{method:"POST",header:{"Content-Type":"application/x-gzip"},data:e.buffer}).then(()=>{this.lastSubmitTime=Date.now(),this.events=[]}));Promise.all(e).catch(u.noop)}catch(e){l.logger.warning(e)}else this.saveEvents()}submitCheck(){return!(!this.sessionId||!this.userBase)&&(Date.now()-this.lastSubmitTime>3e5||this.events.length>=30)}encodeQosSubmitData(){const e=(0,c.groupBy)(this.events,e=>e.session_id||""+JSON.stringify(e.user_base)),t=[];return Object.values(e).forEach(e=>{if(e.length>0){const s={session_id:e[0].session_id,user_base:e[0].user_base,base:this.base,items:e.map(e=>e.event)};l.logger.log("encode",s);const r=new Uint8Array(o.default.zip((0,u.toUTF8Array)(JSON.stringify(s))));t.push(r)}}),t}}t.Qos=g,t.default=new g},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;const r=s(0);t.logger=new class{constructor(e){this.level=e,this.level=e}padingStart(e){const t=e.toString();return t.length<2?"0"+t:t}getLogTimeString(){const e=new Date;return`[${this.padingStart(e.getHours())}:${this.padingStart(e.getMinutes())}:${this.padingStart(e.getSeconds())}.${e.getMilliseconds()}]`}setLevel(e){this.level=this.checkValidate(e)}log(...e){if(this.level!==r.QNLogLevel.VERBOSE)return;const t=this.getLogTimeString()+" %cLOG-QNRTC";console.info(t,"color: #66ccff; font-weight: bold;",...e)}error(...e){const t=this.getLogTimeString()+" %cERROR-QNRTC";console.info(t,"color: #fc5531; font-weight: bold;",...e)}debug(...e){if(this.level!==r.QNLogLevel.VERBOSE&&this.level!==r.QNLogLevel.INFO)return;const t=this.getLogTimeString()+" %cDEBUG-QNRTC";console.info(t,"color: #A28148; font-weight: bold;",...e)}warning(...e){if(this.level===r.QNLogLevel.NONE)return;const t=this.getLogTimeString()+" %cWARNING-QNRTC";console.info(t,"color: #E44F44; font-weight: bold;",...e)}checkValidate(e){return Object.keys(r.QNLogLevel).includes(e)?e:r.QNLogLevel.VERBOSE}}(r.QNLogLevel.VERBOSE)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noop=t.toUTF8Array=t.request=t.rpcid=t.diff=t.timeout=t.getRoomAccessFromToken=void 0;const r=s(11);t.getRoomAccessFromToken=function(e){const t=e.split(":")[2],s=r.Base64.decode(t);return JSON.parse(s)},t.timeout=function(e=1e3){return new Promise(t=>{setTimeout(()=>{t()},e)})};t.diff=(e=[],t=[],s)=>{const r={add:[],remove:[]};if(0===e.length)return r.add=t,r;if(0===t.length)return r.remove=e,r;const i=e.map(s),n=t.map(s);return i.forEach((t,s)=>{-1===n.indexOf(t)&&r.remove.push(e[s])}),n.forEach((e,s)=>{-1===i.indexOf(e)&&r.add.push(t[s])}),r};t.rpcid=()=>Math.random().toString(36).substring(7),t.request=function(e,t){return new Promise((s,r)=>{wx.request({url:e,...t,success:e=>{const t=e.statusCode;t>=200&&t<300?s(e.data):r(e)},fail:r})})},t.toUTF8Array=function(e){const t=[];for(let s=0;s<e.length;s++){let r=e.charCodeAt(s);r<128?t.push(r):r<2048?t.push(192|r>>6,128|63&r):r<55296||r>=57344?t.push(224|r>>12,128|r>>6&63,128|63&r):(s++,r=65536+((1023&r)<<10|1023&e.charCodeAt(s)),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r))}return new Uint8Array(t)};t.noop=()=>{}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SIGNALING_URL=t.QNRTC_EVENTS_STORATE_KEY=t.DEVICE_ID=t.QOS_VERSION=t.VERSION=void 0,t.VERSION="4.0.1",t.QOS_VERSION="2.0",t.DEVICE_ID="wechat miniprogram",t.QNRTC_EVENTS_STORATE_KEY="qnrtcqosevents",t.SIGNALING_URL="wss://rtmpgate.cloudvdn.com/"},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrack=void 0;const r=s(0),i=s(13);class n extends i.QNTrackEvent{constructor(e){super(),this._trackID=e.trackID,this._userID=e.userID,this._tag=e.tag,this._kind=e.kind,this._muted=e.muted}get trackID(){return this._trackID}get userID(){return this._userID}get tag(){return this._tag}isMuted(){return this._muted}isAudio(){return this._kind===r.QNMediaType.audio}isVideo(){return this._kind===r.QNMediaType.video}}t.QNTrack=n},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteUser=void 0;t.QNRemoteUser=class{constructor(e){this._userData=e.userData,this._userID=e.userID,this._audioTracks=e.audioTracks,this._videoTracks=e.videoTracks}get userData(){return this._userData}get userID(){return this._userID}getVideoTracks(){return this._videoTracks}getAudioTracks(){return this._audioTracks}}},function(e,t){e.exports=require("events")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteTrack=void 0;const r=s(6);class i extends r.QNTrack{}t.QNRemoteTrack=i},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=void 0;const o=s(0),a=s(7),c=n(s(2)),u=s(4),d=n(s(12)),l=s(5),h=s(3),g=s(9),m=s(22),p=n(s(1)),f=s(1),_=s(23);class E extends _.QNCore{async join(e,t=""){try{const s=(0,u.getRoomAccessFromToken)(e);this.userId=s.userId,this.roomName=s.roomName,this.appId=s.appId,this.token=e,this.userData=t,c.default.addEvent(c.QosEventType.JoinRoom,{room_token:e,user_data:t})}catch(e){return Promise.reject(p.ERROR_FATAL("can not parse roomToken, "+e))}this.signaling=new d.default(l.SIGNALING_URL,this.appId,e,this.userId,this.roomName,t),this.handleSignaling();try{await this.signaling.init();const e=await this.signaling.sendAuth();return h.logger.log("init",e),this.rtmptoken=e.rtmptoken,this.rtmphost=e.rtmphost,this.tracks=(e.tracks||[]).map(e=>new g.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.users=(e.players||[]).filter(e=>e.playerid!==this.userId).map(e=>{const t=new a.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())});return this.emit(_.QNCore.USER_JOINED,t.userID,t.userData),(t.getAudioTracks().length>0||t.getVideoTracks().length>0)&&this.emit(_.QNCore.USER_PUBLISHED,t.userID,[...t.getAudioTracks(),...t.getVideoTracks()]),t}),Promise.resolve()}catch(e){if(e instanceof f.QNRTCError)return this.signaling.changeState({state:o.QNConnectionState.DISCONNECTED,info:{reason:o.QNConnectionDisconnectedReason.ERROR,errorCode:e.code,errorMessage:e.message}}),Promise.reject(e)}}async leave(){return this._leave()}async publish(e){e(o.QNPublishStatus.READY,{url:`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&playerid=${this.userId}`}),this.publishCallback=e}async subscribe(e){const t=e.videoTrack,s=e.audioTrack;h.logger.log("subscribe tracks:",e);let r="";if(t&&s)r=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&trackid=${s.trackID}&playerid=${t.userID}`;else if(s)r=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${s.trackID}&playerid=${s.userID}`;else{if(!t)return Promise.reject(p.ERROR_FATAL("no subscribe tracks"));r=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&playerid=${t.userID}`}return h.logger.log("subscribe rtmp:",r),r}async sendMessage(e,t,s=[]){const r={msgid:e,target:s.map(e=>e.userID),type:"normal",text:t};return this.signaling.request(d.SignalingType.sendMessage,r).then(()=>Promise.resolve())}async startDirectLiveStreaming(e){var t,s;const r=!!e.audioTrack&&!e.videoTrack,i=[null===(t=e.audioTrack)||void 0===t?void 0:t.trackID,null===(s=e.videoTrack)||void 0===s?void 0:s.trackID].filter(Boolean).map(e=>({trackid:e})),n={id:e.streamID,publishUrl:e.url,audioOnly:r,tracks:i,seiTemplate:{}};e&&e.userConfigExtraInfo&&(n.seiTemplate={value:e.userConfigExtraInfo});const o=Date.now();return this.signaling.request(d.SignalingType.createForwardJob,n).then(e=>(c.default.addEvent(c.QosEventType.CreateForwardJob,{signal_take_time:Date.now()-o,result_code:e.code}),e)).then(()=>Promise.resolve())}async stopDirectLiveStreaming(e){return c.default.addEvent(c.QosEventType.StopForwardJob,{id:e}),this.signaling.request(d.SignalingType.stopForward,{id:e,delayMillisecond:0}).then(()=>Promise.resolve())}async startTranscodingLiveStreaming(e){const t=Date.now(),{streamID:s,renderMode:r,...i}=Object.assign(m.TranscodingLiveStreamingPreset,e);return this.signaling.request(d.SignalingType.createMergeJob,{...i,id:s,rpcid:(0,u.rpcid)(),stretchMode:r}).then(s=>(c.default.addEvent(c.QosEventType.CreateMergeJob,{signal_take_time:Date.now()-t,id:e.streamID,result_code:s.code}),Promise.resolve()))}async stopTranscodingLiveStreaming(e){return c.default.addEvent(c.QosEventType.StopMerge,{id:e}),this.signaling.request(d.SignalingType.stopMerge,{id:e}).then(()=>Promise.resolve())}async setTranscodingLiveStreamingTracks(e,t){const s={id:e,add:(t||[]).map(e=>({trackid:e.trackID,...m.MergeTracksPreset,x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return c.default.addEvent(c.QosEventType.UpdateMergeTracks,s),this.signaling.request(d.SignalingType.updateMergeTracks,s).then(()=>Promise.resolve())}async removeTranscodingLiveStreamingTracks(e,t){const s={id:e,remove:(t||[]).map(e=>({trackid:e.trackID,...m.MergeTracksPreset,x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return c.default.addEvent(c.QosEventType.UpdateMergeTracks,s),this.signaling.request(d.SignalingType.updateMergeTracks,s).then(()=>Promise.resolve())}}t.QNRTCClient=E},function(e,t){e.exports=require("js-base64")},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SignalingType=void 0;const a=s(8),c=s(5),u=s(4),d=s(3),l=n(s(2)),h=o(s(21)),g=s(0),m=n(s(1)),p=s(1);var f;!function(e){e.stopMerge="stop-merge",e.auth="auth",e.sendMessage="send-message",e.createMergeJob="create-merge-job",e.updateMergeTracks="update-merge-tracks",e.createForwardJob="create-forward-job",e.stopForward="stop-forward",e.muteTracks="mute-tracks"}(f=t.SignalingType||(t.SignalingType={}));class _ extends a.EventEmitter{constructor(e,t,s,r,i,n){super(),this.url=e,this.appId=t,this.token=s,this.userId=r,this.roomName=i,this.userData=n,this.reconnectTimeout=3e3,this.reconnectTimeoutID=void 0,this.startAuthTime=0,this.rtmptoken="",l.default.setUserBase(r,i,t)}init(e=!1){return new Promise((t,s)=>{this.changeState({state:e?g.QNConnectionState.RECONNECTING:g.QNConnectionState.CONNECTING}),this.startAuthTime=Date.now(),this.ws&&this.ws.silentClose();const r=new h.default(this.url);r.on("open",()=>{d.logger.log("socketopen"),t()}),r.on("close",e=>{s(m.ERROR_AUTH_FAILED(e.reason))}),r.on("errors",e=>{s(m.ERROR_AUTH_FAILED(e.errMsg))}),r.on("message",this.onMessage.bind(this)),this.ws=r})}onClose(e){switch(d.logger.warning("on socket close: ",e.code,e.reason),this.startAuthTime&&l.default.addEvent(l.QosEventType.SignalAuth,{auth_start_time:this.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:e.code,auth_error_message:e.reason,auth_take_time:Date.now()-this.startAuthTime,access_token:this.token}),Number(e.code)){case 1e3:{const t=m.ERROR_FATAL(e.reason);this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:t.code,errorMessage:t.message,reason:g.QNConnectionDisconnectedReason.ERROR}});break}case 1001:case 1005:case 1006:case 1011:this.reconnect();break;case 1012:this.reconnect(5e3);break;case 1013:this.reconnect();break;case 1014:this.reconnect(5e3)}}onMessage(e){d.logger.log("ws receive",e);const t=e.data.indexOf("=");if(t>0){const s=e.data.substring(0,t),r=JSON.parse(e.data.substring(t+1));this.receiveWsMsg(s,r)}}receiveWsMsg(e,t){"on-rtmp-conn-closed"===e?l.default.addEvent(l.QosEventType.AbnormalDisconnect,{event_reason:"on-rtmp-conn-closed",event_description:t.error}):"ping"===e?this.handlePing():t.rpcid?this.emit("#message#"+t.rpcid,e,t):this.emit("#message",e,t)}send(e,t={}){if(!this.ws)return Promise.reject();const s=`${e}=${JSON.stringify(t)}`;return d.logger.log("ws send",s),this.ws.send(s)}request(e,t={}){return new Promise((s,r)=>{t.rpcid||(t.rpcid=(0,u.rpcid)(),l.default.setRpcId(t.rpcid)),this.send(e,t).catch(r),d.logger.log("send: "+e+JSON.stringify(t)),this.once("#message#"+t.rpcid,(e,t)=>{if(d.logger.log("recv:",e,t),0===t.code)s(t);else switch(t.code){case 10053:r(m.ERROR_INVALID_PARAMETER(t.error));break;case 10001:case 10002:case 10022:r(m.JOIN_ROOM_ERROR(t.code,t.error));break;default:r(m.SERVER_ERROR(t.code,t.error))}})})}close(){this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.ws&&this.ws.silentClose()}handlePing(){this.state!==g.QNConnectionState.CONNECTED&&this.state!==g.QNConnectionState.RECONNECTED||this.send("pong",{}),this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.reconnectTimeoutID=setTimeout(()=>{d.logger.warning("signaling: websocket heartbeat timeout"),this.reconnect()},9e3)}changeState(e){l.default.addEvent(l.QosEventType.RoomStateChanged,{room_state:e.state}),d.logger.log("RoomStateChanged",e.state),this.emit("connection-state-changed",e.state,e.auth,e.info),this.state=e.state}reconnect(e=1e3){return this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.state===g.QNConnectionState.DISCONNECTED?(this.ws&&this.ws.silentClose(),Promise.resolve()):(this.reconnectTask||(this.reconnectTimeoutID=setTimeout(()=>{const e=m.ERROR_RECONNECT_FAILED();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}}),this.reconnectTimeoutID=void 0},this.reconnectTimeout),d.logger.log("signaling: websocket reconnecting"),this.reconnectTask=(0,u.timeout)(e).then(this.init.bind(this,!0)).then(this.sendAuth.bind(this,!0)).then(e=>(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0,this.reconnectTask=void 0,d.logger.log("signaling: websocket reconnected"),e)).catch(e=>{if(this.reconnectTask=void 0,e instanceof p.QNRTCError){if(10001!==e.code)return this.reconnect();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}})}})),this.reconnectTask)}async sendAuth(e=!1){var t,s,r;let i;i=this.rtmptoken?{rtmptoken:this.rtmptoken}:{app:this.appId,agent:c.DEVICE_ID,roomtoken:this.token,sdkversion:c.VERSION,room:this.roomName,user:this.userId,playerdata:this.userData},l.default.setSessionId(this.rtmptoken||this.token);try{const n=await this.request(f.auth,i);return this.changeState({state:e?g.QNConnectionState.RECONNECTED:g.QNConnectionState.CONNECTED,auth:n}),l.default.addEvent(l.QosEventType.SignalAuth,{auth_start_time:this.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:n.code,auth_error_message:n.error,auth_take_time:Date.now()-this.startAuthTime,access_token:this.token}),null===(t=this.ws)||void 0===t||t.removeAllListeners("close"),null===(s=this.ws)||void 0===s||s.removeAllListeners("errors"),null===(r=this.ws)||void 0===r||r.on("close",this.onClose.bind(this)),this.rtmptoken=n.rtmptoken,n}catch(e){return Promise.reject(e)}}}t.default=_},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrackEvent=t.QNRTCClinetEvent=void 0;const r=s(8);class i extends r.EventEmitter{addListener(){return this}}t.QNRTCClinetEvent=i,i.USER_JOINED="user-joined",i.USER_LEFT="user-left",i.USER_PUBLISHED="user-published",i.USER_UNPUBLISHED="user-unpublished",i.CONNECTION_STATE_CHANGED="connection-state-changed",i.MESSAGE_RECEIVED="message-received";class n extends r.EventEmitter{addListener(){return this}}t.QNTrackEvent=n,n.MUTE_STATE_CHANGED="mute-state-changed"},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.QNLocalTrack=void 0;const o=s(6),a=n(s(2)),c=s(1);class u extends o.QNTrack{async setMuted(e){return new Promise((t,s)=>{this.emit("mute",{tracks:{trackid:this.trackID,muted:e}},t,s)}).then(()=>{this._muted=e,a.default.addEvent(a.QosEventType.MuteTracks,{result_code:0,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]})}).catch(t=>{if(t instanceof c.QNRTCError)return a.default.addEvent(a.QosEventType.MuteTracks,{result_code:t.code,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]}),Promise.reject(t)})}}t.QNLocalTrack=u},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=t.default=void 0;var n=s(16);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return n.QNRTC}});var o=s(10);Object.defineProperty(t,"QNRTCClient",{enumerable:!0,get:function(){return o.QNRTCClient}}),i(s(14),t),i(s(9),t),i(s(7),t),i(s(6),t),i(s(0),t)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTC=void 0;const r=s(10),i=s(5),n=s(3);t.QNRTC=class{static createClient(){return new r.QNRTCClient}static get VERSION(){return i.VERSION}static setLogLevel(e){n.logger.setLevel(e)}}},function(e,t){e.exports=require("fingerprintjs2")},function(e,t){e.exports=require("blueimp-md5")},function(e,t){e.exports=require("gzip-js")},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupBy=t.find=void 0;t.find=(e,t)=>e&&0!==e.length?e.find(t):null;t.groupBy=(e,t)=>{if(!e||0===e.length)return{};const s={};return e.forEach(e=>{const r=t(e);s[r]?s[r].push(e):s[r]=[e]}),s}},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=s(8),a=s(3),c=n(s(1));class u extends o.EventEmitter{constructor(e){super();const t=this;this.socketTask=wx.connectSocket({url:e,success:e=>{a.logger.log("success:"+JSON.stringify(e))},fail(e){a.logger.error("fail:"+JSON.stringify(e)),setTimeout(()=>{t.emit("errors",e)},0)}}),this.socketTask&&(this.socketTask.onClose(this.emit.bind(this,"close")),this.socketTask.onError(this.emit.bind(this,"errors")),this.socketTask.onMessage(this.emit.bind(this,"message")),this.socketTask.onOpen(this.emit.bind(this,"open")))}send(e){return new Promise((t,s)=>{this.socketTask.send({data:e,success:t,fail:e=>{s(c.ERROR_FATAL(e.errMsg))}})})}close(){this.socketTask.close({fail:e=>a.logger.error("close",e)})}silentClose(){this.removeAllListeners(),this.socketTask.close({fail:e=>a.logger.error("close",e)})}}t.default=u},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergeTracksPreset=t.TranscodingLiveStreamingPreset=void 0;const r=s(0);t.TranscodingLiveStreamingPreset={publishUrl:"",audioOnly:"",height:"",width:"",fps:"",kbps:"",minRate:"",maxRate:"",renderMode:"aspectFill",holdLastFrame:!1,watermarks:[],background:{}},t.MergeTracksPreset={x:0,y:0,w:0,h:0,z:0,stretchMode:r.QNRenderMode.ASPECT_FILL}},function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.QNCore=void 0;const o=s(0),a=s(7),c=s(13),u=n(s(2)),d=s(12),l=s(9),h=s(4),g=s(14),m=s(6),p=n(s(1));class f extends c.QNRTCClinetEvent{constructor(){super(...arguments),this.localTracks=[],this.userId="",this.roomName="",this.appId="",this.token="",this.rtmptoken="",this.rtmphost="",this.userData="",this.tracks=[],this.users=[]}handleSignaling(){this.signaling&&(this.signaling.on("#message",this.onMessage.bind(this)),this.signaling.on("connection-state-changed",this.onConnectionStateChanged.bind(this)))}onMessage(e,t){var s,r,i;switch(e){case"on-player-in":this.onPlayerIn(new a.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-player-out":this.onPlayerOut(new a.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-add-tracks":this.onAddTracks(t);break;case"on-remove-tracks":this.onRemoveTracks(t);break;case"on-add-local-tracks":this.onAddLocalTracks(t.tracks);break;case"disconnect":10006===t.code?(u.default.addEvent(u.QosEventType.KickoutUser,{user_id:this.userId,result_code:t.code,signal_take_time:0}),null===(s=this.signaling)||void 0===s||s.changeState({state:o.QNConnectionState.DISCONNECTED,info:{reason:o.QNConnectionDisconnectedReason.KICKED_OUT,errorCode:t.code}})):0===t.code?null===(r=this.signaling)||void 0===r||r.changeState({state:o.QNConnectionState.DISCONNECTED,info:{reason:o.QNConnectionDisconnectedReason.LEAVE,errorCode:t.code}}):null===(i=this.signaling)||void 0===i||i.changeState({state:o.QNConnectionState.DISCONNECTED,info:{reason:o.QNConnectionDisconnectedReason.ERROR,errorCode:t.code,errorMessage:t.error}});break;case"on-messages":this.onMessageReceived(t);break;case"mute-tracks":this.onMuteTracks(t)}}onConnectionStateChanged(e,t,s){if(e===o.QNConnectionState.RECONNECTED){this.rtmptoken=t.rtmptoken,this.rtmphost=t.rtmphost;const s=(t.players||[]).filter(e=>e.playerid!==this.userId),r=(t.tracks||[]).filter(e=>e.playerid!==this.userId);Promise.resolve().then(()=>{const e=(0,h.diff)(this.tracks,r.map(e=>new l.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),e=>e.trackID);e.remove.length>0&&this.onPlayerUnPublish(e.remove),e.add.length>0&&this.onPlayerPublish(e.add);const t=(0,h.diff)(this.users,s.map(e=>new a.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())})),e=>e.userID);t.remove.forEach(this.onPlayerOut,this),t.add.forEach(this.onPlayerIn,this)}),this.emit(f.CONNECTION_STATE_CHANGED,e)}else e===o.QNConnectionState.DISCONNECTED?(this.emit(f.CONNECTION_STATE_CHANGED,e,s),this.releaseRoom({code:null==s?void 0:s.errorCode})):this.emit(f.CONNECTION_STATE_CHANGED,e)}onAddLocalTracks(e){this.localTracks=e.map(e=>new g.QNLocalTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.localTracks.forEach(e=>{e.on("mute",async(e,t,s)=>{try{t(await this.signaling.request(d.SignalingType.muteTracks,e))}catch(e){s(e)}})}),u.default.addEvent(u.QosEventType.PublishTracks,{signal_take_time:0,result_code:0,tracks:(this.localTracks||[]).map(e=>({local_id:"",track_id:e.trackID,source_type:"",kind:e._kind,tag:e.tag,muted:e.isMuted(),kbps:"",encode_video_width:0,encode_video_height:0}))}),this.publishCallback(o.QNPublishStatus.COMPLATED,{tracks:this.localTracks})}onRemoveTracks(e){const t=e.tracks.map(e=>new l.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{if(t.userID===e.userID)if(e.isAudio()){const s=t._audioTracks.findIndex(t=>t.trackID===e.trackID);s>=0&&t._audioTracks.splice(s,1)}else if(e.isVideo()){const s=t._audioTracks.findIndex(t=>t.trackID===e.trackID);s>=0&&t._audioTracks.splice(s,1)}})}),this.onPlayerUnPublish(t)}onAddTracks(e){const t=e.tracks.map(e=>new l.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{t.userID===e.userID&&(e.isAudio()?t._audioTracks.push(e):e.isVideo()&&t._videoTracks.push(e))})}),this.onPlayerPublish(t)}onMessageReceived(e){for(let t of e.messages)this.emit(f.MESSAGE_RECEIVED,{ID:t.msgid,userID:t.playerid,content:t.text,timestamp:t.msgts})}onMuteTracks(e){for(let t of e.tracks){const e=this.tracks.findIndex(e=>e.trackID===t.trackid);e>=0&&(this.tracks[e]._muted=t.muted,this.tracks[e].emit(m.QNTrack.MUTE_STATE_CHANGED))}}onPlayerOut(e){this.users=this.users.filter(t=>t.userID!==e.userID),this.emit(f.USER_LEFT,e.userID)}onPlayerIn(e){const t=this.users.findIndex(t=>t.userID===e.userID);t>=0?this.users[t]=e:this.users.push(e),this.emit(f.USER_JOINED,e.userID,e.userData)}onPlayerPublish(e){let t={};e.forEach(e=>{const s=this.tracks.findIndex(t=>t.trackID===e.trackID);s>=0?this.tracks[s]=e:this.tracks.push(e),t[e.userID]?t[e.userID].push(e):t[e.userID]=[e]});for(let e in t)this.emit(f.USER_PUBLISHED,e,t[e])}onPlayerUnPublish(e){let t=[];this.tracks=this.tracks.filter(s=>!e.some(e=>e.trackID===s.trackID)||(t.push(s),!1));let s={};t.forEach(e=>{s[e.userID]?s[e.userID].push(e):s[e.userID]=[e]});for(let e in s)this.emit(f.USER_UNPUBLISHED,e,s[e])}releaseRoom(e){u.default.addEvent(u.QosEventType.LeaveRoom,{leave_reason_code:e.code},!0),this.removeAllListeners(),this.localTracks=[],this.tracks=[],this.users=[],u.default.addEvent(u.QosEventType.UnInit,{id:"track_"+Date.now()},!0),this.signaling&&(this.signaling.close(),this.signaling=void 0)}async _leave(){return this.signaling?this.signaling.send("disconnect").then(()=>Promise.resolve()).catch(e=>Promise.reject(e)):Promise.reject(p.ERROR_INVALID_STATE())}}t.QNCore=f}]);
//# sourceMappingURL=index.js.map