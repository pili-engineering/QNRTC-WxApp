module.exports=function(e){var t={};function r(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(s,n,function(t){return e[t]}.bind(null,n));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=15)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNPublishStatus=t.QNConnectionDisconnectedReason=t.QNConnectionState=t.QNLogLevel=t.QNRenderMode=t.QNMediaType=void 0,function(e){e.audio="audio",e.video="video"}(t.QNMediaType||(t.QNMediaType={})),function(e){e.FILL="scaleToFit",e.ASPECT_FILL="aspectFill",e.ASPECT_FIT="aspectFit"}(t.QNRenderMode||(t.QNRenderMode={})),function(e){e.VERBOSE="VERBOSE",e.INFO="INFO",e.WARNING="WARNING",e.ERROR="ERROR",e.NONE="NONE"}(t.QNLogLevel||(t.QNLogLevel={})),function(e){e.DISCONNECTED="DISCONNECTED",e.CONNECTING="CONNECTING",e.CONNECTED="CONNECTED",e.RECONNECTING="RECONNECTING",e.RECONNECTED="RECONNECTED"}(t.QNConnectionState||(t.QNConnectionState={})),function(e){e.LEAVE="LEAVE",e.KICKED_OUT="KICKED_OUT",e.ERROR="ERROR"}(t.QNConnectionDisconnectedReason||(t.QNConnectionDisconnectedReason={})),function(e){e.READY="READY",e.COMPLATED="COMPLATED",e.ERROR="ERROR"}(t.QNPublishStatus||(t.QNPublishStatus={}))},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ERROR_INVALID_PARAMETER=t.JOIN_ROOM_ERROR=t.SERVER_ERROR=t.ERROR_FATAL=t.ERROR_NETWORK_TIMEOUT=t.ERROR_RECONNECT_FAILED=t.ERROR_INVALID_STATE=t.ERROR_AUTH_FAILED=t.QNRTCError=void 0;const o=i(r(2));class a extends Error{constructor(e,t){super(t),this.code=e,this.error=t,o.default.addEvent(o.QosEventType.SDKError,{error_code:e,error_msg:t})}}t.QNRTCError=a;t.ERROR_AUTH_FAILED=e=>{new a(21001,"error connect websocket "+e)};t.ERROR_INVALID_STATE=()=>new a(21002,"error invalid state");t.ERROR_RECONNECT_FAILED=()=>new a(21003,"websocket reconnectTimes run out, reconnect stops");t.ERROR_NETWORK_TIMEOUT=()=>new a(21004,"error network timeout");t.ERROR_FATAL=e=>new a(21005,"unexpected error "+e);t.SERVER_ERROR=(e,t)=>new a(e,t);t.JOIN_ROOM_ERROR=(e,t)=>new a(e,t);t.ERROR_INVALID_PARAMETER=e=>new a(10053,e)},function(e,t,r){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Qos=t.QosEventType=void 0;const n=s(r(17)),i=s(r(18)),o=s(r(19)),a=r(11),c=r(20),u=r(4),d=r(5),l=r(3);var h;!function(e){e[e.Init=1]="Init",e[e.UnInit=2]="UnInit",e[e.JoinRoom=3]="JoinRoom",e[e.MCSAuth=4]="MCSAuth",e[e.SignalAuth=5]="SignalAuth",e[e.LeaveRoom=6]="LeaveRoom",e[e.PublisherPC=7]="PublisherPC",e[e.PublishTracks=8]="PublishTracks",e[e.UnPublishTracks=9]="UnPublishTracks",e[e.SubscriberPC=10]="SubscriberPC",e[e.SubscribeTracks=11]="SubscribeTracks",e[e.UnSubscribeTracks=12]="UnSubscribeTracks",e[e.MuteTracks=13]="MuteTracks",e[e.ICEConnectionState=14]="ICEConnectionState",e[e.CallbackStatistics=15]="CallbackStatistics",e[e.KickoutUser=16]="KickoutUser",e[e.RoomStateChanged=17]="RoomStateChanged",e[e.AudioDeviceInOut=18]="AudioDeviceInOut",e[e.VideoDeviceInOut=19]="VideoDeviceInOut",e[e.SDKError=20]="SDKError",e[e.ApplicationState=21]="ApplicationState",e[e.CreateMergeJob=22]="CreateMergeJob",e[e.UpdateMergeTracks=23]="UpdateMergeTracks",e[e.StopMerge=24]="StopMerge",e[e.DeviceChanged=25]="DeviceChanged",e[e.DefaultSetting=26]="DefaultSetting",e[e.MediaStatistics=27]="MediaStatistics",e[e.AbnormalDisconnect=28]="AbnormalDisconnect",e[e.WechatPlayerStatus=29]="WechatPlayerStatus",e[e.WechatPlayerStatistics=30]="WechatPlayerStatistics",e[e.WechatPusherStatus=31]="WechatPusherStatus",e[e.WechatPusherStatistics=32]="WechatPusherStatistics",e[e.CreateForwardJob=33]="CreateForwardJob",e[e.StopForwardJob=34]="StopForwardJob"}(h=t.QosEventType||(t.QosEventType={}));class f{constructor(){this.events=[],this.sessionId="",this.rpcId="",this.userBase={user_id:"",room_name:"",app_id:""};const e=wx.getSystemInfoSync();l.logger.log("weappInfo",e),this.base={qos_version:d.QOS_VERSION,device_id:d.DEVICE_ID,bundle_id:"",app_version:e.version,sdk_version:d.VERSION,device_model:e.model,os_platform:e.platform,os_version:e.system,app_sdkVersion:e.SDKVersion},this.lastSubmitTime=Date.now(),this.recoverStoredEvents()}getDeviceId(){return new Promise(e=>{window&&window.requestIdleCallback?window.requestIdleCallback(()=>{n.default.get(t=>{const r=(0,i.default)(JSON.stringify(t));e(r)})}):setTimeout(()=>{n.default.get(t=>{const r=(0,i.default)(JSON.stringify(t));e(r)})},500)})}setSessionId(e){for(let t=this.events.length-1;t>=0;--t){const r=this.events[t];r.session_id||(r.session_id=e)}this.sessionId=e}setRpcId(e){this.rpcId=e}setUserBase(e,t,r){this.userBase={user_id:e,room_name:t,app_id:r};for(let e=this.events.length-1;e>=0;--e){const t=this.events[e];t.user_base||(t.user_base=this.userBase)}}addEvent(e,t,r=!1){const s=Object.assign({timestamp:Date.now(),event_id:e,event_name:h[e]},t);this.events.push({user_base:this.userBase,event:s,session_id:this.sessionId,rpc_id:this.rpcId}),this.submit(r)}recoverStoredEvents(){let e="";try{e=wx.getStorageSync(d.QNRTC_EVENTS_STORATE_KEY)}catch(e){l.logger.warning("get storage error",e)}l.logger.log("get item",e);try{wx.removeStorageSync(d.QNRTC_EVENTS_STORATE_KEY)}catch(e){l.logger.warning("remove storage error",e)}if(!e)return;let t=JSON.parse(decodeURIComponent((0,a.atob)(e)));t=(t||[]).filter(e=>!!e.session_id&&!!e.user_base).sort((e,t)=>e.event.timestamp-t.event.timestamp),t&&(this.events=t)}saveEvents(){const e=(0,a.btoa)(encodeURIComponent(JSON.stringify(this.events)));try{wx.setStorageSync(d.QNRTC_EVENTS_STORATE_KEY,e)}catch(e){l.logger.warning("storage error",e)}}submit(e=!1){if(e||this.submitCheck())try{const e=this.encodeQosSubmitData().map(e=>(0,u.request)("https://pili-rtc-qos.qiniuapi.com/v1/rtcevent",{method:"POST",header:{"Content-Type":"application/x-gzip"},data:e.buffer}).then(()=>{this.lastSubmitTime=Date.now(),this.events=[]}));Promise.all(e).catch(u.noop)}catch(e){l.logger.warning(e)}else this.saveEvents()}submitCheck(){return!(!this.sessionId||!this.userBase)&&(Date.now()-this.lastSubmitTime>3e5||this.events.length>=30)}encodeQosSubmitData(){const e=(0,c.groupBy)(this.events,e=>e.session_id||""+JSON.stringify(e.user_base)),t=[];return Object.values(e).forEach(e=>{if(e.length>0){const r={session_id:e[0].session_id,user_base:e[0].user_base,base:this.base,items:e.map(e=>e.event)};l.logger.log("encode",r);const s=new Uint8Array(o.default.zip((0,u.toUTF8Array)(JSON.stringify(r))));t.push(s)}}),t}}t.Qos=f,t.default=new f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;const s=r(0);t.logger=new class{constructor(e){this.level=e,this.level=e}padingStart(e){const t=e.toString();return t.length<2?"0"+t:t}getLogTimeString(){const e=new Date;return`[${this.padingStart(e.getHours())}:${this.padingStart(e.getMinutes())}:${this.padingStart(e.getSeconds())}.${e.getMilliseconds()}]`}setLevel(e){this.level=this.checkValidate(e)}log(...e){if(this.level!==s.QNLogLevel.VERBOSE)return;const t=this.getLogTimeString()+" %cLOG-QNRTC";console.info(t,"color: #66ccff; font-weight: bold;",...e)}error(...e){const t=this.getLogTimeString()+" %cERROR-QNRTC";console.info(t,"color: #fc5531; font-weight: bold;",...e)}debug(...e){if(this.level!==s.QNLogLevel.VERBOSE&&this.level!==s.QNLogLevel.INFO)return;const t=this.getLogTimeString()+" %cDEBUG-QNRTC";console.info(t,"color: #A28148; font-weight: bold;",...e)}warning(...e){if(this.level===s.QNLogLevel.NONE)return;const t=this.getLogTimeString()+" %cWARNING-QNRTC";console.info(t,"color: #E44F44; font-weight: bold;",...e)}checkValidate(e){return Object.keys(s.QNLogLevel).includes(e)?e:s.QNLogLevel.VERBOSE}}(s.QNLogLevel.VERBOSE)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noop=t.toUTF8Array=t.request=t.rpcid=t.diff=t.timeout=t.getRoomAccessFromToken=void 0;const s=r(11);t.getRoomAccessFromToken=function(e){const t=e.split(":")[2],r=(0,s.decode)(t);return JSON.parse(r)},t.timeout=function(e=1e3){return new Promise(t=>{setTimeout(()=>{t()},e)})};t.diff=(e=[],t=[],r)=>{const s={add:[],remove:[]};if(0===e.length)return s.add=t,s;if(0===t.length)return s.remove=e,s;const n=e.map(r),i=t.map(r);return n.forEach((t,r)=>{-1===i.indexOf(t)&&s.remove.push(e[r])}),i.forEach((e,r)=>{-1===n.indexOf(e)&&s.add.push(t[r])}),s};t.rpcid=()=>Math.random().toString(36).substring(7),t.request=function(e,t){return new Promise((r,s)=>{wx.request(Object.assign(Object.assign({url:e},t),{success:e=>{const t=e.statusCode;t>=200&&t<300?r(e.data):s(e)},fail:s}))})},t.toUTF8Array=function(e){const t=[];for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):(r++,s=65536+((1023&s)<<10|1023&e.charCodeAt(r)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return new Uint8Array(t)};t.noop=()=>{}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SIGNALING_URL=t.QNRTC_EVENTS_STORATE_KEY=t.DEVICE_ID=t.QOS_VERSION=t.VERSION=void 0,t.VERSION="4.0.4",t.QOS_VERSION="2.0",t.DEVICE_ID="wechat miniprogram",t.QNRTC_EVENTS_STORATE_KEY="qnrtcqosevents",t.SIGNALING_URL="wss://rtmpgate.cloudvdn.com/"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrack=void 0;const s=r(0),n=r(13);class i extends n.QNTrackEvent{constructor(e){super(),this._trackID=e.trackID,this._userID=e.userID,this._tag=e.tag,this._kind=e.kind,this._muted=e.muted}get trackID(){return this._trackID}get userID(){return this._userID}get tag(){return this._tag}isMuted(){return this._muted}isAudio(){return this._kind===s.QNMediaType.audio}isVideo(){return this._kind===s.QNMediaType.video}}t.QNTrack=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteUser=void 0;t.QNRemoteUser=class{constructor(e){this._userData=e.userData,this._userID=e.userID,this._audioTracks=e.audioTracks,this._videoTracks=e.videoTracks}get userData(){return this._userData}get userID(){return this._userID}getVideoTracks(){return this._videoTracks}getAudioTracks(){return this._audioTracks}}},function(e,t){e.exports=require("events")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNRemoteTrack=void 0;const s=r(6);class n extends s.QNTrack{}t.QNRemoteTrack=n},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t},o=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))},a=this&&this.__rest||function(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]])}return r};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=void 0;const c=r(0),u=r(7),d=i(r(2)),l=r(4),h=i(r(12)),f=r(5),g=r(3),p=r(9),m=r(22),v=i(r(1)),_=r(1),E=r(23);class T extends E.QNCore{join(e,t=""){return o(this,void 0,void 0,(function*(){try{const r=(0,l.getRoomAccessFromToken)(e);this.userId=r.userId,this.roomName=r.roomName,this.appId=r.appId,this.token=e,this.userData=t,d.default.addEvent(d.QosEventType.JoinRoom,{room_token:e,user_data:t})}catch(e){return Promise.reject(v.ERROR_FATAL("can not parse roomToken, "+e))}this.signaling=new h.default(f.SIGNALING_URL,this.appId,e,this.userId,this.roomName,t),this.handleSignaling();try{yield this.signaling.init();const e=yield this.signaling.sendAuth();return g.logger.log("init",e),this.rtmptoken=e.rtmptoken,this.rtmphost=e.rtmphost,this.tracks=(e.tracks||[]).map(e=>new p.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.users=(e.players||[]).filter(e=>e.playerid!==this.userId).map(e=>{const t=new u.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())});return this.emit(E.QNCore.USER_JOINED,t.userID,t.userData),(t.getAudioTracks().length>0||t.getVideoTracks().length>0)&&this.emit(E.QNCore.USER_PUBLISHED,t.userID,[...t.getAudioTracks(),...t.getVideoTracks()]),t}),Promise.resolve()}catch(e){if(e instanceof _.QNRTCError)return this.signaling.changeState({state:c.QNConnectionState.DISCONNECTED,info:{reason:c.QNConnectionDisconnectedReason.ERROR,errorCode:e.code,errorMessage:e.message}}),Promise.reject(e)}}))}leave(){return o(this,void 0,void 0,(function*(){return this._leave()}))}publish(e){return o(this,void 0,void 0,(function*(){e(c.QNPublishStatus.READY,{url:`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&playerid=${this.userId}`}),this.publishCallback=e}))}subscribe(e){return o(this,void 0,void 0,(function*(){const t=e.videoTrack,r=e.audioTrack;g.logger.log("subscribe tracks:",e);let s="";if(t&&r)s=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&trackid=${r.trackID}&playerid=${t.userID}`;else if(r)s=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${r.trackID}&playerid=${r.userID}`;else{if(!t)return Promise.reject(v.ERROR_FATAL("no subscribe tracks"));s=`rtmp://${this.rtmphost}/?rtmptoken=${this.rtmptoken}&trackid=${t.trackID}&playerid=${t.userID}`}return g.logger.log("subscribe rtmp:",s),s}))}sendMessage(e,t,r=[]){return o(this,void 0,void 0,(function*(){const s={msgid:e,target:r.map(e=>e.userID),type:"normal",text:t};return this.signaling.request(h.SignalingType.sendMessage,s).then(()=>Promise.resolve())}))}startDirectLiveStreaming(e){var t,r;return o(this,void 0,void 0,(function*(){const s=!!e.audioTrack&&!e.videoTrack,n=[null===(t=e.audioTrack)||void 0===t?void 0:t.trackID,null===(r=e.videoTrack)||void 0===r?void 0:r.trackID].filter(Boolean).map(e=>({trackid:e})),i={id:e.streamID,publishUrl:e.url,audioOnly:s,tracks:n,seiTemplate:{}};e&&e.userConfigExtraInfo&&(i.seiTemplate={value:e.userConfigExtraInfo});const o=Date.now();return this.signaling.request(h.SignalingType.createForwardJob,i).then(e=>(d.default.addEvent(d.QosEventType.CreateForwardJob,{signal_take_time:Date.now()-o,result_code:e.code}),e)).then(()=>Promise.resolve())}))}stopDirectLiveStreaming(e){return o(this,void 0,void 0,(function*(){return d.default.addEvent(d.QosEventType.StopForwardJob,{id:e}),this.signaling.request(h.SignalingType.stopForward,{id:e,delayMillisecond:0}).then(()=>Promise.resolve())}))}startTranscodingLiveStreaming(e){return o(this,void 0,void 0,(function*(){const t=Date.now(),r=Object.assign(m.TranscodingLiveStreamingPreset,e),{streamID:s,renderMode:n}=r,i=a(r,["streamID","renderMode"]);return this.signaling.request(h.SignalingType.createMergeJob,Object.assign(Object.assign({},i),{id:s,rpcid:(0,l.rpcid)(),stretchMode:n})).then(r=>(d.default.addEvent(d.QosEventType.CreateMergeJob,{signal_take_time:Date.now()-t,id:e.streamID,result_code:r.code}),Promise.resolve()))}))}stopTranscodingLiveStreaming(e){return o(this,void 0,void 0,(function*(){return d.default.addEvent(d.QosEventType.StopMerge,{id:e}),this.signaling.request(h.SignalingType.stopMerge,{id:e}).then(()=>Promise.resolve())}))}setTranscodingLiveStreamingTracks(e,t){return o(this,void 0,void 0,(function*(){const r={id:e,add:(t||[]).map(e=>Object.assign(Object.assign({trackid:e.trackID},m.MergeTracksPreset),{x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return d.default.addEvent(d.QosEventType.UpdateMergeTracks,r),this.signaling.request(h.SignalingType.updateMergeTracks,r).then(()=>Promise.resolve())}))}removeTranscodingLiveStreamingTracks(e,t){return o(this,void 0,void 0,(function*(){const r={id:e,remove:(t||[]).map(e=>Object.assign(Object.assign({trackid:e.trackID},m.MergeTracksPreset),{x:e.x,y:e.y,w:e.width,h:e.height,z:e.zOrder,stretchMode:e.renderMode}))};return d.default.addEvent(d.QosEventType.UpdateMergeTracks,r),this.signaling.request(h.SignalingType.updateMergeTracks,r).then(()=>Promise.resolve())}))}}t.QNRTCClient=T},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Base64=t.extendBuiltins=t.extendUint8Array=t.extendString=t.toUint8Array=t.fromUint8Array=t.isValid=t.decode=t.btou=t.encodeURL=t.encodeURI=t.encode=t.utob=t.toBase64=t.fromBase64=t.btoaPolyfill=t.btoa=t.atobPolyfill=t.atob=t.VERSION=t.version=void 0;t.version="3.7.2";t.VERSION="3.7.2";const s="function"==typeof atob,n="function"==typeof btoa,i="function"==typeof Buffer,o="function"==typeof TextDecoder?new TextDecoder:void 0,a="function"==typeof TextEncoder?new TextEncoder:void 0,c=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),u=(e=>{let t={};return e.forEach((e,r)=>t[e]=r),t})(c),d=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,l=String.fromCharCode.bind(String),h="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(e,t=(e=>e))=>new Uint8Array(Array.prototype.slice.call(e,0).map(t)),f=e=>e.replace(/=/g,"").replace(/[+\/]/g,e=>"+"==e?"-":"_"),g=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),p=e=>{let t,r,s,n,i="";const o=e.length%3;for(let o=0;o<e.length;){if((r=e.charCodeAt(o++))>255||(s=e.charCodeAt(o++))>255||(n=e.charCodeAt(o++))>255)throw new TypeError("invalid character found");t=r<<16|s<<8|n,i+=c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}return o?i.slice(0,o-3)+"===".substring(o):i};t.btoaPolyfill=p;const m=n?e=>btoa(e):i?e=>Buffer.from(e,"binary").toString("base64"):p;t.btoa=m;const v=i?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let r=0,s=e.length;r<s;r+=4096)t.push(l.apply(null,e.subarray(r,r+4096)));return m(t.join(""))},_=(e,t=!1)=>t?f(v(e)):v(e);t.fromUint8Array=_;const E=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?l(192|t>>>6)+l(128|63&t):l(224|t>>>12&15)+l(128|t>>>6&63)+l(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return l(240|t>>>18&7)+l(128|t>>>12&63)+l(128|t>>>6&63)+l(128|63&t)},T=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,k=e=>e.replace(T,E);t.utob=k;const b=i?e=>Buffer.from(e,"utf8").toString("base64"):a?e=>v(a.encode(e)):e=>m(k(e)),R=(e,t=!1)=>t?f(b(e)):b(e);t.toBase64=R,t.encode=R;const y=e=>R(e,!0);t.encodeURI=y,t.encodeURL=y;const N=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,S=e=>{switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return l(55296+(t>>>10))+l(56320+(1023&t));case 3:return l((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return l((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},O=e=>e.replace(N,S);t.btou=O;const I=e=>{if(e=e.replace(/\s+/g,""),!d.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));let t,r,s,n="";for(let i=0;i<e.length;)t=u[e.charAt(i++)]<<18|u[e.charAt(i++)]<<12|(r=u[e.charAt(i++)])<<6|(s=u[e.charAt(i++)]),n+=64===r?l(t>>16&255):64===s?l(t>>16&255,t>>8&255):l(t>>16&255,t>>8&255,255&t);return n};t.atobPolyfill=I;const D=s?e=>atob(g(e)):i?e=>Buffer.from(e,"base64").toString("binary"):I;t.atob=D;const C=i?e=>h(Buffer.from(e,"base64")):e=>h(D(e),e=>e.charCodeAt(0)),P=e=>C(w(e));t.toUint8Array=P;const A=i?e=>Buffer.from(e,"base64").toString("utf8"):o?e=>o.decode(C(e)):e=>O(D(e)),w=e=>g(e.replace(/[-_]/g,e=>"-"==e?"+":"/")),Q=e=>A(w(e));t.fromBase64=Q,t.decode=Q;const M=e=>{if("string"!=typeof e)return!1;const t=e.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(t)||!/[^\s0-9a-zA-Z\-_]/.test(t)};t.isValid=M;const L=e=>({value:e,enumerable:!1,writable:!0,configurable:!0}),j=function(){const e=(e,t)=>Object.defineProperty(String.prototype,e,L(t));e("fromBase64",(function(){return Q(this)})),e("toBase64",(function(e){return R(this,e)})),e("toBase64URI",(function(){return R(this,!0)})),e("toBase64URL",(function(){return R(this,!0)})),e("toUint8Array",(function(){return P(this)}))};t.extendString=j;const U=function(){const e=(e,t)=>Object.defineProperty(Uint8Array.prototype,e,L(t));e("toBase64",(function(e){return _(this,e)})),e("toBase64URI",(function(){return _(this,!0)})),e("toBase64URL",(function(){return _(this,!0)}))};t.extendUint8Array=U;const x=()=>{j(),U()};t.extendBuiltins=x;const B={version:"3.7.2",VERSION:"3.7.2",atob:D,atobPolyfill:I,btoa:m,btoaPolyfill:p,fromBase64:Q,toBase64:R,encode:R,encodeURI:y,encodeURL:y,utob:k,btou:O,decode:Q,isValid:M,fromUint8Array:_,toUint8Array:P,extendString:j,extendUint8Array:U,extendBuiltins:x};t.Base64=B},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t},o=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SignalingType=void 0;const c=r(8),u=r(5),d=r(4),l=r(3),h=i(r(2)),f=a(r(21)),g=r(0),p=i(r(1)),m=r(1);var v;!function(e){e.stopMerge="stop-merge",e.auth="auth",e.sendMessage="send-message",e.createMergeJob="create-merge-job",e.updateMergeTracks="update-merge-tracks",e.createForwardJob="create-forward-job",e.stopForward="stop-forward",e.muteTracks="mute-tracks"}(v=t.SignalingType||(t.SignalingType={}));class _ extends c.EventEmitter{constructor(e,t,r,s,n,i){super(),this.url=e,this.appId=t,this.token=r,this.userId=s,this.roomName=n,this.userData=i,this.reconnectTimeout=3e3,this.reconnectTimeoutID=void 0,this.startAuthTime=0,this.rtmptoken="",h.default.setUserBase(s,n,t)}init(e=!1){return new Promise((t,r)=>{this.changeState({state:e?g.QNConnectionState.RECONNECTING:g.QNConnectionState.CONNECTING}),this.startAuthTime=Date.now(),this.ws&&this.ws.silentClose();const s=new f.default(this.url);s.on("open",()=>{l.logger.log("socketopen"),t()}),s.on("close",e=>{r(p.ERROR_AUTH_FAILED(e.reason))}),s.on("errors",e=>{r(p.ERROR_AUTH_FAILED(e.errMsg))}),s.on("message",this.onMessage.bind(this)),this.ws=s})}onClose(e){switch(l.logger.warning("on socket close: ",e.code,e.reason),this.startAuthTime&&h.default.addEvent(h.QosEventType.SignalAuth,{auth_start_time:this.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:e.code,auth_error_message:e.reason,auth_take_time:Date.now()-this.startAuthTime,access_token:this.token}),Number(e.code)){case 1e3:{const t=p.ERROR_FATAL(e.reason);this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:t.code,errorMessage:t.message,reason:g.QNConnectionDisconnectedReason.ERROR}});break}case 1001:case 1005:case 1006:case 1011:this.reconnect();break;case 1012:this.reconnect(5e3);break;case 1013:this.reconnect();break;case 1014:this.reconnect(5e3)}}onMessage(e){l.logger.log("ws receive",e);const t=e.data.indexOf("=");if(t>0){const r=e.data.substring(0,t),s=JSON.parse(e.data.substring(t+1));this.receiveWsMsg(r,s)}}receiveWsMsg(e,t){"on-rtmp-conn-closed"===e?h.default.addEvent(h.QosEventType.AbnormalDisconnect,{event_reason:"on-rtmp-conn-closed",event_description:t.error}):"ping"===e?this.handlePing():t.rpcid?this.emit("#message#"+t.rpcid,e,t):this.emit("#message",e,t)}send(e,t={}){if(!this.ws)return Promise.reject();const r=`${e}=${JSON.stringify(t)}`;return l.logger.log("ws send",r),this.ws.send(r)}request(e,t={}){return new Promise((r,s)=>{t.rpcid||(t.rpcid=(0,d.rpcid)(),h.default.setRpcId(t.rpcid)),this.send(e,t).catch(s),l.logger.log("send: "+e+JSON.stringify(t)),this.once("#message#"+t.rpcid,(e,t)=>{if(l.logger.log("recv:",e,t),0===t.code)r(t);else switch(t.code){case 10053:s(p.ERROR_INVALID_PARAMETER(t.error));break;case 10001:case 10002:case 10022:s(p.JOIN_ROOM_ERROR(t.code,t.error));break;default:s(p.SERVER_ERROR(t.code,t.error))}})})}close(){this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.ws&&this.ws.silentClose()}handlePing(){this.state!==g.QNConnectionState.CONNECTED&&this.state!==g.QNConnectionState.RECONNECTED||this.send("pong",{}),this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.reconnectTimeoutID=setTimeout(()=>{l.logger.warning("signaling: websocket heartbeat timeout"),this.reconnect()},9e3)}changeState(e){h.default.addEvent(h.QosEventType.RoomStateChanged,{room_state:e.state}),l.logger.log("RoomStateChanged",e.state),this.emit("connection-state-changed",e.state,e.auth,e.info),this.state=e.state}reconnect(e=1e3){return this.reconnectTimeoutID&&(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0),this.state===g.QNConnectionState.DISCONNECTED?(this.ws&&this.ws.silentClose(),Promise.resolve()):(this.reconnectTask||(this.reconnectTimeoutID=setTimeout(()=>{const e=p.ERROR_RECONNECT_FAILED();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}}),this.reconnectTimeoutID=void 0},this.reconnectTimeout),l.logger.log("signaling: websocket reconnecting"),this.reconnectTask=(0,d.timeout)(e).then(this.init.bind(this,!0)).then(this.sendAuth.bind(this,!0)).then(e=>(clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=void 0,this.reconnectTask=void 0,l.logger.log("signaling: websocket reconnected"),e)).catch(e=>{if(this.reconnectTask=void 0,e instanceof m.QNRTCError){if(10001!==e.code)return this.reconnect();this.changeState({state:g.QNConnectionState.DISCONNECTED,info:{errorCode:e.code,errorMessage:e.message,reason:g.QNConnectionDisconnectedReason.ERROR}})}})),this.reconnectTask)}sendAuth(e=!1){var t,r,s;return o(this,void 0,void 0,(function*(){let n;n=this.rtmptoken?{rtmptoken:this.rtmptoken}:{app:this.appId,agent:u.DEVICE_ID,roomtoken:this.token,sdkversion:u.VERSION,room:this.roomName,user:this.userId,playerdata:this.userData},h.default.setSessionId(this.rtmptoken||this.token);try{const i=yield this.request(v.auth,n);return this.changeState({state:e?g.QNConnectionState.RECONNECTED:g.QNConnectionState.CONNECTED,auth:i}),h.default.addEvent(h.QosEventType.SignalAuth,{auth_start_time:this.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:i.code,auth_error_message:i.error,auth_take_time:Date.now()-this.startAuthTime,access_token:this.token}),null===(t=this.ws)||void 0===t||t.removeAllListeners("close"),null===(r=this.ws)||void 0===r||r.removeAllListeners("errors"),null===(s=this.ws)||void 0===s||s.on("close",this.onClose.bind(this)),this.rtmptoken=i.rtmptoken,i}catch(e){return Promise.reject(e)}}))}}t.default=_},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QNTrackEvent=t.QNRTCClinetEvent=void 0;const s=r(8);class n extends s.EventEmitter{addListener(){return this}}t.QNRTCClinetEvent=n,n.USER_JOINED="user-joined",n.USER_LEFT="user-left",n.USER_PUBLISHED="user-published",n.USER_UNPUBLISHED="user-unpublished",n.CONNECTION_STATE_CHANGED="connection-state-changed",n.MESSAGE_RECEIVED="message-received";class i extends s.EventEmitter{addListener(){return this}}t.QNTrackEvent=i,i.MUTE_STATE_CHANGED="mute-state-changed"},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t},o=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.QNLocalTrack=void 0;const a=r(6),c=i(r(2)),u=r(1);class d extends a.QNTrack{setMuted(e){return o(this,void 0,void 0,(function*(){return new Promise((t,r)=>{this.emit("mute",{tracks:[{trackid:this.trackID,muted:e}]},t,r)}).then(()=>{this._muted=e,c.default.addEvent(c.QosEventType.MuteTracks,{result_code:0,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]})}).catch(t=>{if(t instanceof u.QNRTCError)return c.default.addEvent(c.QosEventType.MuteTracks,{result_code:t.code,signal_take_time:0,tracks:[{track_id:this.trackID,muted:e,kind:this._kind}]}),Promise.reject(t)})}))}}t.QNLocalTrack=d},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||s(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTCClient=t.default=void 0;var i=r(16);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return i.QNRTC}});var o=r(10);Object.defineProperty(t,"QNRTCClient",{enumerable:!0,get:function(){return o.QNRTCClient}}),n(r(14),t),n(r(9),t),n(r(7),t),n(r(6),t),n(r(0),t)},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.QNRTC=void 0;const o=r(10),a=r(5),c=r(3),u=i(r(2));t.QNRTC=class{static createClient(){return new o.QNRTCClient}static get VERSION(){return a.VERSION}static setLogLevel(e){c.logger.setLevel(e)}static updatePlayerStateChange(e){e&&e.detail?u.default.addEvent(u.QosEventType.WechatPlayerStatus,e.detail):c.logger.error("updatePlayerStateChange params is wrong")}static updatePlayerNetStatus(e){e&&e.detail&&e.detail.info?u.default.addEvent(u.QosEventType.WechatPlayerStatistics,e.detail.info):c.logger.error("updatePlayerNetStatus param is wrong")}static updatePusherStateChange(e){e&&e.detail?u.default.addEvent(u.QosEventType.WechatPusherStatus,e.detail):c.logger.error("updatePusherStateChange params is wrong")}static updatePusherNetStatus(e){e&&e.detail&&e.detail.info?u.default.addEvent(u.QosEventType.WechatPusherStatistics,e.detail.info):c.logger.error("updatePusherNetStatus param is wrong")}}},function(e,t){e.exports=require("fingerprintjs2")},function(e,t){e.exports=require("blueimp-md5")},function(e,t){e.exports=require("gzip-js")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupBy=t.find=void 0;t.find=(e,t)=>e&&0!==e.length?e.find(t):null;t.groupBy=(e,t)=>{if(!e||0===e.length)return{};const r={};return e.forEach(e=>{const s=t(e);r[s]?r[s].push(e):r[s]=[e]}),r}},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=r(8),a=r(3),c=i(r(1));class u extends o.EventEmitter{constructor(e){super();const t=this;this.socketTask=wx.connectSocket({url:e,success:e=>{a.logger.log("success:"+JSON.stringify(e))},fail(e){a.logger.error("fail:"+JSON.stringify(e)),setTimeout(()=>{t.emit("errors",e)},0)}}),this.socketTask&&(this.socketTask.onClose(this.emit.bind(this,"close")),this.socketTask.onError(this.emit.bind(this,"errors")),this.socketTask.onMessage(this.emit.bind(this,"message")),this.socketTask.onOpen(this.emit.bind(this,"open")))}send(e){return new Promise((t,r)=>{this.socketTask.send({data:e,success:t,fail:e=>{r(c.ERROR_FATAL(e.errMsg))}})})}close(){this.socketTask.close({fail:e=>a.logger.error("close",e)})}silentClose(){this.removeAllListeners(),this.socketTask.close({fail:e=>a.logger.error("close",e)})}}t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MergeTracksPreset=t.TranscodingLiveStreamingPreset=void 0;const s=r(0);t.TranscodingLiveStreamingPreset={publishUrl:"",audioOnly:"",height:"",width:"",fps:"",kbps:"",minRate:"",maxRate:"",renderMode:"aspectFill",holdLastFrame:!1,watermarks:[],background:{}},t.MergeTracksPreset={x:0,y:0,w:0,h:0,z:0,stretchMode:s.QNRenderMode.ASPECT_FILL}},function(e,t,r){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&s(t,e,r);return n(t,e),t},o=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(n,i){function o(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.QNCore=void 0;const a=r(0),c=r(7),u=r(13),d=i(r(2)),l=r(12),h=r(9),f=r(4),g=r(14),p=r(6),m=i(r(1));class v extends u.QNRTCClinetEvent{constructor(){super(...arguments),this.localTracks=[],this.userId="",this.roomName="",this.appId="",this.token="",this.rtmptoken="",this.rtmphost="",this.userData="",this.tracks=[],this.users=[]}handleSignaling(){this.signaling&&(this.signaling.on("#message",this.onMessage.bind(this)),this.signaling.on("connection-state-changed",this.onConnectionStateChanged.bind(this)))}onMessage(e,t){var r,s,n;switch(e){case"on-player-in":this.onPlayerIn(new c.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-player-out":this.onPlayerOut(new c.QNRemoteUser({userData:t.playerdata,userID:t.playerid,audioTracks:[],videoTracks:[]}));break;case"on-add-tracks":this.onAddTracks(t);break;case"on-remove-tracks":this.onRemoveTracks(t);break;case"on-add-local-tracks":this.onAddLocalTracks(t.tracks);break;case"disconnect":10006===t.code?(d.default.addEvent(d.QosEventType.KickoutUser,{user_id:this.userId,result_code:t.code,signal_take_time:0}),null===(r=this.signaling)||void 0===r||r.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.KICKED_OUT,errorCode:t.code}})):0===t.code?null===(s=this.signaling)||void 0===s||s.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.LEAVE,errorCode:t.code}}):null===(n=this.signaling)||void 0===n||n.changeState({state:a.QNConnectionState.DISCONNECTED,info:{reason:a.QNConnectionDisconnectedReason.ERROR,errorCode:t.code,errorMessage:t.error}});break;case"on-messages":this.onMessageReceived(t);break;case"mute-tracks":this.onMuteTracks(t)}}onConnectionStateChanged(e,t,r){if(e===a.QNConnectionState.RECONNECTED){this.rtmptoken=t.rtmptoken,this.rtmphost=t.rtmphost;const r=(t.players||[]).filter(e=>e.playerid!==this.userId),s=(t.tracks||[]).filter(e=>e.playerid!==this.userId);Promise.resolve().then(()=>{const e=(0,f.diff)(this.tracks,s.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),e=>e.trackID);e.remove.length>0&&this.onPlayerUnPublish(e.remove),e.add.length>0&&this.onPlayerPublish(e.add);const t=(0,f.diff)(this.users,r.map(e=>new c.QNRemoteUser({userData:e.playerdata,userID:e.playerid,audioTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isAudio()),videoTracks:this.tracks.filter(t=>t.userID==e.playerid&&t.isVideo())})),e=>e.userID);t.remove.forEach(this.onPlayerOut,this),t.add.forEach(this.onPlayerIn,this)}),this.emit(v.CONNECTION_STATE_CHANGED,e)}else e===a.QNConnectionState.DISCONNECTED?(this.emit(v.CONNECTION_STATE_CHANGED,e,r),this.releaseRoom({code:null==r?void 0:r.errorCode})):this.emit(v.CONNECTION_STATE_CHANGED,e)}onAddLocalTracks(e){this.localTracks=e.map(e=>new g.QNLocalTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind})),this.localTracks.forEach(e=>{e.on("mute",(e,t,r)=>o(this,void 0,void 0,(function*(){try{const r=yield this.signaling.request(l.SignalingType.muteTracks,e);t(r)}catch(e){r(e)}})))}),d.default.addEvent(d.QosEventType.PublishTracks,{signal_take_time:0,result_code:0,tracks:(this.localTracks||[]).map(e=>({local_id:"",track_id:e.trackID,source_type:"",kind:e._kind,tag:e.tag,muted:e.isMuted(),kbps:"",encode_video_width:0,encode_video_height:0}))}),this.publishCallback(a.QNPublishStatus.COMPLATED,{tracks:this.localTracks})}onRemoveTracks(e){const t=e.tracks.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{if(t.userID===e.userID)if(e.isAudio()){const r=t._audioTracks.findIndex(t=>t.trackID===e.trackID);r>=0&&t._audioTracks.splice(r,1)}else if(e.isVideo()){const r=t._audioTracks.findIndex(t=>t.trackID===e.trackID);r>=0&&t._audioTracks.splice(r,1)}})}),this.onPlayerUnPublish(t)}onAddTracks(e){const t=e.tracks.map(e=>new h.QNRemoteTrack({trackID:e.trackid,userID:e.playerid,tag:e.tag,muted:e.muted,kind:e.kind}));t.forEach(e=>{this.users.forEach(t=>{t.userID===e.userID&&(e.isAudio()?t._audioTracks.push(e):e.isVideo()&&t._videoTracks.push(e))})}),this.onPlayerPublish(t)}onMessageReceived(e){for(let t of e.messages)this.emit(v.MESSAGE_RECEIVED,{ID:t.msgid,userID:t.playerid,content:t.text,timestamp:t.msgts})}onMuteTracks(e){for(let t of e.tracks){const e=this.tracks.findIndex(e=>e.trackID===t.trackid);e>=0&&(this.tracks[e]._muted=t.muted,this.tracks[e].emit(p.QNTrack.MUTE_STATE_CHANGED))}}onPlayerOut(e){this.users=this.users.filter(t=>t.userID!==e.userID),this.emit(v.USER_LEFT,e.userID)}onPlayerIn(e){const t=this.users.findIndex(t=>t.userID===e.userID);t>=0?this.users[t]=e:this.users.push(e),this.emit(v.USER_JOINED,e.userID,e.userData)}onPlayerPublish(e){let t={};e.forEach(e=>{const r=this.tracks.findIndex(t=>t.trackID===e.trackID);r>=0?this.tracks[r]=e:this.tracks.push(e),t[e.userID]?t[e.userID].push(e):t[e.userID]=[e]});for(let e in t)this.emit(v.USER_PUBLISHED,e,t[e])}onPlayerUnPublish(e){let t=[];this.tracks=this.tracks.filter(r=>!e.some(e=>e.trackID===r.trackID)||(t.push(r),!1));let r={};t.forEach(e=>{r[e.userID]?r[e.userID].push(e):r[e.userID]=[e]});for(let e in r)this.emit(v.USER_UNPUBLISHED,e,r[e])}releaseRoom(e){d.default.addEvent(d.QosEventType.LeaveRoom,{leave_reason_code:e.code},!0),this.removeAllListeners(),this.localTracks=[],this.tracks=[],this.users=[],d.default.addEvent(d.QosEventType.UnInit,{id:"track_"+Date.now()},!0),this.signaling&&(this.signaling.close(),this.signaling=void 0)}_leave(){return o(this,void 0,void 0,(function*(){return this.signaling?this.signaling.send("disconnect").then(()=>Promise.resolve()).catch(e=>Promise.reject(e)):Promise.reject(m.ERROR_INVALID_STATE())}))}}t.QNCore=v}]);
//# sourceMappingURL=index.js.map