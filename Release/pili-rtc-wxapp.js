module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=7)}([function(e,t,r){"use strict";function n(){var e=new Date;function t(e){var t=e.toString();return t.length<2?"0"+t:t}return"["+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+e.getMilliseconds()+"]"}t.__esModule=!0,t.log=t.LogModel=void 0;var s=function(){function e(e){this.level=e}var t=e.prototype;return t.setLevel=function(e){this.level=this.checkValidate(e)},t.log=function(){var e;if("log"===this.level){for(var t=n()+" %cLOG-QNRTC",r="color: #66ccff; font-weight: bold;",s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];(e=console).info.apply(e,[t,r].concat(i))}},t.debug=function(){var e;if("log"===this.level||"debug"===this.level){for(var t=n()+" %cDEBUG-QNRTC",r="color: #A28148; font-weight: bold;",s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];(e=console).info.apply(e,[t,r].concat(i))}},t.warning=function(){var e;if("disable"!==this.level){for(var t=n()+" %cWARNING-QNRTC",r="color: #E44F44; font-weight: bold;",s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];(e=console).warn.apply(e,[t,r].concat(i))}},t.checkValidate=function(e){return["log","debug","warning","disable"].includes(e)?e:"log"},e}();t.LogModel=s;var i=new s("log");t.log=i},function(e,t,r){"use strict";t.__esModule=!0,t.diff=void 0,t.getRoomAccessFromToken=function(e){var t=e.split(":")[2],r=n.Base64.decode(t);return i.log.log(r),JSON.parse(r)},t.request=function(e,t){return new Promise((function(r,n){wx.request(Object.assign({url:e},t,{success:function(e){var t=e.statusCode;t>=200&&t<300?r(e.data):n(e)},fail:n}))}))},t.rpcid=void 0,t.timeout=function(e){void 0===e&&(e=1e3);return new Promise((function(t){setTimeout((function(){t()}),e)}))};var n=r(5),s=r(4),i=r(0);t.diff=function(e,t,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===r&&(r=s.identity);var n={add:[],remove:[]};if(0===e.length)return n.add=t,n;if(0===t.length)return n.remove=e,n;var i=e.map(r),o=t.map(r);return i.forEach((function(t,r){-1===o.indexOf(t)&&n.remove.push(e[r])})),o.forEach((function(e,r){-1===i.indexOf(e)&&n.add.push(t[r])})),n};t.rpcid=function(){return Math.random().toString(36).substring(7)}},function(e,t){e.exports=require("events")},function(e,t,r){"use strict";t.__esModule=!0,t.version=void 0;t.version="1.2.3"},function(e,t,r){"use strict";t.__esModule=!0,t.propNotEq=t.prop=t.identity=t.groupBy=t.find=void 0;t.identity=function(e){return e};t.prop=function(e){return function(t){return t[e]}};t.propNotEq=function(e,t){return function(r){return r[e]!==t}};t.find=function(e,t){return e&&0!==e.length?e.find(t):null};t.groupBy=function(e,t){if(!e||0===e.length)return null;var r={};return e.forEach((function(e){var n=t(e);r[n]?r[n].push(e):r[n]=[e]})),r}},function(e,t){e.exports=require("js-base64")},function(e,t,r){"use strict";t.__esModule=!0,t.default=t.QosEventType=t.Qos=void 0;var n=l(r(10)),s=l(r(11)),i=l(r(12)),o=r(5),a=r(4),c=r(1),u=r(3),d=r(0);function l(e){return e&&e.__esModule?e:{default:e}}var h={Init:1,UnInit:2,JoinRoom:3,MCSAuth:4,SignalAuth:5,LeaveRoom:6,PublisherPC:7,PublishTracks:8,UnPublishTracks:9,SubscriberPC:10,SubscribeTracks:11,UnSubscribeTracks:13,MuteTracks:14,ICEConnectionState:15,CallbackStatistics:16,KickoutUser:17,RoomStateChanged:18,AudioDeviceInOut:19,VideoDeviceInOut:20,SDKError:21,ApplicationState:22,CreateMergeJob:24,UpdateMergeTracks:25,StopMerge:26,DeviceChanged:28,DefaultSetting:29,MediaStatistics:30,AbnormalDisconnect:31,WechatPlayerStatus:32,WechatPlayerStatistics:33,WechatPusherStatus:34,WechatPusherStatistics:35};function f(){}t.QosEventType=h;var g=function(){function e(){var e=this;new Promise((function(e){window&&window.requestIdleCallback?window.requestIdleCallback((function(){n.default.get((function(t){var r=(0,s.default)(JSON.stringify(t));e(r)}))})):setTimeout((function(){n.default.get((function(t){var r=(0,s.default)(JSON.stringify(t));e(r)}))}),500)})).then((function(t){return e.deviceId=t,e.base.device_id=e.deviceId,t})).catch((function(t){d.log.warning("get deviceId error",t),e.base.device_id="unknow"})),this.events=[],this.sessionId=null,this.rpcId=null,this.userBase=null;var t=wx.getSystemInfoSync();d.log.log("weappInfo",t),this.base={qos_version:"2.0",device_id:"",bundle_id:"",app_version:t.version,sdk_version:u.version,device_model:t.model,os_platform:"wechat miniprogram",os_version:t.system,app_sdkVersion:t.SDKVersion,host_environment:t.platform},this.deviceId=null,this.lastSubmitTime=Date.now(),this._recoverStoredEvents()}var t=e.prototype;return t.setSessionId=function(e){for(var t=this.events.length-1;t>=0;--t){var r=this.events[t];r.session_id||(r.session_id=e)}this.sessionId=e},t.setRpcId=function(e){this.rpcId=e},t.setUserBase=function(e,t,r){this.userBase={user_id:e,room_name:t,app_id:r};for(var n=this.events.length-1;n>=0;--n){var s=this.events[n];s.user_base||(s.user_base=this.userBase)}},t.addEvent=function(e,t,r){var n=Object.assign({timestamp:Date.now(),event_id:h[e],event_name:e},t);this._addEvent(n,r)},t._recoverStoredEvents=function(){var e=function(){var e;try{e=wx.getStorageSync("qnrtcqosevents")}catch(e){d.log.warning("get storage error",e)}d.log.log("get item",e);try{wx.removeStorageSync("qnrtcqosevents")}catch(e){d.log.warning("remove storage error",e)}if(e)return(JSON.parse(decodeURIComponent(o.Base64.atob(e)))||[]).filter((function(e){return!!e.session_id&&!!e.user_base})).sort((function(e,t){return e.event.timestamp-t.event.timestamp}))}();e&&(this.events=e)},t.saveEvents=function(){var e=o.Base64.btoa(encodeURIComponent(JSON.stringify(this.events)));try{wx.setStorageSync("qnrtcqosevents",e)}catch(e){d.log.warning("storage error",e)}},t._addEvent=function(e,t){this.events.push({user_base:this.userBase,event:e,session_id:this.sessionId,app_id:this.appId,rpc_id:this.rpcId}),this.events.length>900&&(this.events=this.events.slice(30)),this._submit(t)},t._submit=function(e){var t=this;if(!!e||this.submitCheck())try{var r=this.encodeQosSubmitData().map((function(e){return(0,c.request)("https://pili-rtc-qos.qiniuapi.com/v1/rtcevent",{method:"POST",header:{"Content-Type":"application/x-gzip"},data:e.buffer}).then((function(){t.lastSubmitTime=Date.now(),t.events=[]}))}));Promise.all(r).catch(f)}catch(e){d.log.warning(e)}else this.saveEvents()},t.submitCheck=function(){return!!(this.sessionId&&this.deviceId&&this.userBase)&&(Date.now()-this.lastSubmitTime>3e5||this.events.length%30==0)},t.encodeQosSubmitData=function(){var e=this,t=(0,a.groupBy)(this.events,(function(e){return e.session_id||""+JSON.stringify(e.user_base)})),r=[];return Object.values(t).forEach((function(t){if(t.length>0){var n={session_id:t[0].session_id,user_base:t[0].user_base,base:e.base,items:t.map((function(e){return e.event}))};d.log.log("encode",n);var s=new Uint8Array(i.default.zip(function(e){for(var t=[],r=0;r<e.length;r++){var n=e.charCodeAt(r);n<128?t.push(n):n<2048?t.push(192|n>>6,128|63&n):n<55296||n>=57344?t.push(224|n>>12,128|n>>6&63,128|63&n):(r++,n=65536+((1023&n)<<10|1023&e.charCodeAt(r)),t.push(240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n))}return new Uint8Array(t)}(JSON.stringify(n))));r.push(s)}})),r},e}();t.Qos=g;var m=new g;t.default=m},function(e,t,r){"use strict";t.__esModule=!0;var n=a(r(8));t.RoomSession=n.default;var s=a(r(1));t.util=s.default;var i=r(3);t.version=i.version;var o=r(0);function a(e){return e&&e.__esModule?e:{default:e}}t.log=o.log,o.log.log("QNRTC_Version: ",i.version)},function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var n,s=r(2),i=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=d(t);if(r&&r.has(e))return r.get(e);var n={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var i in e)if("default"!==i&&Object.prototype.hasOwnProperty.call(e,i)){var o=s?Object.getOwnPropertyDescriptor(e,i):null;o&&(o.get||o.set)?Object.defineProperty(n,i,o):n[i]=e[i]}n.default=e,r&&r.set(e,n);return n}(r(9)),o=r(1),a=(n=r(6))&&n.__esModule?n:{default:n},c=r(4),u=r(0);function d(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(d=function(e){return e?r:t})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h=function(e){var t,r;function n(t){var r;((r=e.call(this)||this).users=[],r.tracks=[],r.localTracks=[],r.subscribedMap={},r.pushContext=null,r.rtmphost="",r.signalingurl="wss://rtmpgate.cloudvdn.com/",r.mergeJobs=[],r.mergingJobs=[],r.muteLocalTracks=[],t&&t.server&&(r.signalingurl=t.server),a.default.addEvent("Init",{id:"track_"+Date.now()}),"function"==typeof getApp)&&(getApp().qiniuQos=a.default);return r}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,l(t,r);var s=n.prototype;return s.joinRoomWithToken=function(e,t){var r=this;try{var n=(0,o.getRoomAccessFromToken)(e);this.userId=n.userId,this.roomName=n.roomName,this.appId=n.appId,this.token=e,this.userData=t,a.default.addEvent("JoinRoom",{room_token:e,user_data:t})}catch(e){return Promise.reject(e)}return this.ws=new i.default(this.signalingurl,this.appId,e,this.userId,this.roomName,t),this.ws.on("#message",this.onMessage.bind(this)),this.ws.on("@error",this.onError.bind(this)),this.ws.on("#closed",(function(e){r.releaseRoom(e),r.emit("disconnected",e)})),this.ws.init().then((function(e){return u.log.log("init",e),r.users=e.players||[],r.tracks=e.tracks||[],r.rtmptoken=e.rtmptoken,r.rtmphost=e.rtmphost,r.ws.on("connected",r.onConnected.bind(r)),r.ws.on("reconnecting",(function(){return r.emit("reconnecting")})),e}))},s.updatePushContext=function(e){this.pushContext=e},s.closeLogger=function(){u.log.setLevel("disable")},s.openLogger=function(){u.log.setLevel("log")},s.onConnected=function(e){var t=this;u.log.log("connected",e),this.emit("reconnected"),this.rtmptoken=e.rtmptoken,this.rtmphost=e.rtmphost;var r=e.players||[],n=(e.tracks||[]).filter((0,c.propNotEq)("playerid",this.userId)),s=(0,o.diff)(this.users,r,(0,c.prop)("playerid")),i=(0,o.diff)(this.tracks,n,(0,c.prop)("trackid"));return Promise.resolve().then((function(){return s.remove.forEach(t.handlePlayerOut,t),i.remove.length>0&&t.handleRemoveTracks({tracks:i.remove}),s.add.forEach(t.handlePlayerIn,t),i.add.length>0&&t.handleAddTracks({tracks:i.add}),!0}))},s.onError=function(e){this.emit("error",e)},s.onMessage=function(e,t){var r=this;switch(e){case"on-player-in":this.handlePlayerIn(t);break;case"on-player-out":this.handlePlayerOut(t);break;case"on-add-tracks":this.handleAddTracks(t);break;case"on-remove-tracks":this.handleRemoveTracks(t);break;case"on-add-local-tracks":this.handleAddLocalTracks(t);break;case"on-remove-local-tracks":this.handleRemoveLocalTracks(t);break;case"disconnect":10006===t.code&&a.default.addEvent("KickoutUser",{user_id:this.userId,result_code:t.code,signal_take_time:0}),this.emit("disconnect",t),this.leaveRoom(t);break;case"create-merge-job-res":this.handleCreateMergeJob(t);break;case"update-merge-tracks-res":this.handleUpdateMergeTracks(t);break;case"stop-merge-res":this.handleStopMerge(t);break;case"on-messages":this.handleOnMessages(t);break;case"mute-tracks":this.handleMuteTracks(t);break;case"mute-tracks-res":0===t.code&&this.muteLocalTracks.forEach((function(e){r.localTracks.forEach((function(t){e.trackid===t.trackid&&(t.muted=e.muted)}))}))}},s.handlePlayerIn=function(e){var t=this.users.indexOf((function(t){return t.playerid===e.playerid}));-1!==t?this.users[t]=e:this.users.push(e),this.emit("user-join",e)},s.handlePlayerOut=function(e){this.users=this.users.filter((function(t){return t.playerid!==e.playerid})),this.emit("user-leave",e)},s.handleAddTracks=function(e){var t=this;e.tracks.forEach((function(e){var r=t.tracks.indexOf((function(t){return t.trackid===e.trackid}));-1!==r?t.tracks[r]=e:t.tracks.push(e)})),this.emit("track-add",e.tracks)},s.handleRemoveTracks=function(e){this.tracks=this.tracks.filter((function(t){return!e.tracks.some((function(e){return e.trackid===t.trackid}))})),this.emit("track-remove",e.tracks)},s.handleAddLocalTracks=function(e){this.localTracks=e.tracks,a.default.addEvent("PublishTracks",{signal_take_time:0,result_code:0,tracks:(e.tracks||[]).map((function(e){return{local_id:"",track_id:e.trackid,source_type:"",kind:e.kind,tag:e.tag,muted:e.muted,master:e.master,kbps:"",encode_video_width:0,encode_video_height:0}}))}),this.emit("local-track-add",e.tracks)},s.handleRemoveLocalTracks=function(e){this.localTracks=[],this.emit("local-track-remove",e.tracks)},s.handleCreateMergeJob=function(e){if(0===e.code){var t=this.newMergeJob;this.mergeJobs.push(t),this.newMergeJob=null,this.emit("merge-job-create",t,this.mergeJobs)}},s.handleUpdateMergeTracks=function(e){var t=(0,c.find)(this.mergeJobs,(function(t){return t.rpcid===e.rpcid}));0===e.code&&t&&(-1===this.mergingJobs.indexOf(t.id)&&this.mergingJobs.push(t.id),this.emit("merge-update",t,this.mergeJobs))},s.handleStopMerge=function(e){var t=(0,c.find)(this.mergeJobs,(function(t){return t.rpcid===e.rpcid}));0===e.code&&t&&(this.mergeJobs=this.mergeJobs.filter((function(t){return t.rpcid!==e.rpcid})),this.mergingJobs=this.mergingJobs.filter((function(e){return e!==t.id})),this.emit("merge-stop",t,this.mergeJobs))},s.handleOnMessages=function(e){this.emit("message-recv",e)},s.handleMuteTracks=function(e){var t=e.tracks;this.emit("mute-tracks",t)},s.publish=function(){return"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&playerid="+this.userId},s.subscribe=function(e){if(this.tracks&&e!==this.userId){var t=this.tracks.filter((function(t){return t.playerid===e&&t.master}));if(u.log.log("subscribe tracks:",t),0!==t.length){var r=t.map((function(e){return e.trackid}));return u.log.log("subscribe trackids:",r),a.default.addEvent("SubscribeTracks",{result_code:0,signal_take_time:0,tracks:(t||[]).map((function(e){return{track_id:e.trackid,status:e.status}}))}),"rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&trackid="+r.join("&trackid=")+"&playerid="+e}}},s.getSubscribeAddressList=function(e){var t=this;if(this.tracks&&e!==this.userid){u.log.log("getSubscribeAddressList this.tracks:",this.tracks);var r=this.tracks.filter((function(t){return t.playerid===e}));if(u.log.log("getSubscribeAddressList tracks:",r),0!==r.length){var n=[],s={},i=[];return r.forEach((function(r){if(r.master)i.push(r.trackid);else if("video"===r.kind){var s={};s.url="rtmp://"+t.rtmphost+"/?rtmptoken="+t.rtmptoken+"&trackid="+r.trackid+"&playerid="+e,s.master=!1,n.push(s)}})),i.length>0&&(s.url="rtmp://"+this.rtmphost+"/?rtmptoken="+this.rtmptoken+"&trackid="+i.join("&trackid=")+"&playerid="+e,s.master=!0,n.push(s)),u.log.log("subscribeAddressList:",n),a.default.addEvent("SubscribeTracks",{result_code:0,signal_take_time:0,tracks:(r||[]).map((function(e){return{track_id:e.trackid,status:e.status}}))}),n}}},s.muteTracks=function(e){var t=this,r=[];e.forEach((function(e){t.localTracks.forEach((function(t){if(t.trackid===e.trackid){var n={};n.track_id=e.trackid,n.muted=e.muted,n.kind=t.kind,r.push(n)}}))})),a.default.addEvent("MuteTracks",{result_code:0,signal_take_time:0,tracks:r}),this.muteLocalTracks=e;var n={};n.tracks=e.map((function(e){return{trackid:e.trackid,muted:e.muted}})),this.ws.request("mute-tracks",n)},s.createMergeJob=function(e,t){if(!this.newMergeJob){return this.newMergeJob=Object.assign({publishUrl:"",audioOnly:"",height:"",width:"",fps:"",kbps:"",minRate:"",maxRate:"",stretchMode:"aspectFill",holdLastFrame:!1,watermarks:[],background:{}},t,{id:e,rpcid:(0,o.rpcid)()}),this.ws.sendCreateMergeJob(this.newMergeJob)}},s.updateMergeTracks=function(e){return this.ws.sendUpdateMergeTracks(e)},s.addMergeTracks=function(e,t){return this.updateMergeTracks({id:t,add:e})},s.removeMergeTracks=function(e,t){return this.updateMergeTracks({id:t,remove:e})},s.stopMerge=function(e){return this.ws.sendStopMerge(e)},s.sendMessage=function(e,t){return this.ws.sendSendMessage(e,t)},s.leaveRoom=function(e){if(this.ws)return a.default.addEvent("LeaveRoom",{leave_reason_code:e&&e.code},!0),this.ws.send("disconnect").then(this.releaseRoom.bind(this)).catch(this.releaseRoom.bind(this))},s.releaseRoom=function(e){a.default.addEvent("LeaveRoom",{leave_reason_code:e.code},!0),this.removeAllListeners(),a.default.addEvent("UnInit",{id:"track_"+Date.now()},!0),this.ws&&(this.ws.close(),this.ws.changeState(i.SignalingState.CLOSED))},n}(s.EventEmitter);t.default=h},function(e,t,r){"use strict";t.__esModule=!0,t.default=t.SignalingState=void 0;var n=r(2),s=r(3),i=r(1),o=u(r(6)),a=u(r(13)),c=r(0);function u(e){return e&&e.__esModule?e:{default:e}}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};t.SignalingState=l;var h=function(e){var t,r;function n(t,r,n,s,i,a){var c;return(c=e.call(this)||this).url=t,c.app=r,c.accessToken=n,c.user=s,c.room=i,c.userData=a||"",c.reconnectTimeout=1e4,o.default.setUserBase(s,i,r),c}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,d(t,r);var u=n.prototype;return u.init=function(){var e=this;return new Promise((function(t,r){e.changeState(l.CONNECTING),e.startAuthTime=Date.now(),e.ws&&e.ws.silentClose();var n=new a.default(e.url);n.on("open",(function(){c.log.log("socketopen"),t(e.sendAuth().then((function(t){return e.changeState(l.OPEN),o.default.addEvent("SignalAuth",{auth_start_time:e.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:t.code,auth_error_message:t.error,auth_take_time:Date.now()-e.startAuthTime,access_token:e.accessToken}),n.off("close",r),n.on("close",e.onClose.bind(e)),e.rtmptoken=t.rtmptoken,e.changeState(l.OPEN),e.emit("connected",t),t})))})),n.on("close",r),n.on("message",e.onMessage.bind(e)),e.ws=n}))},u.onOpen=function(e){c.log.log("on socket open",e),this.emit("#open",e)},u.onClose=function(e){switch(c.log.log("on socket close: ",e.code,e.reason),this.startAuthTime&&o.default.addEvent("SignalAuth",{auth_start_time:this.startAuthTime,auth_dns_time:0,auth_server_ip:"",auth_error_code:e.code,auth_error_message:e.reason,auth_take_time:Date.now()-this.startAuthTime,access_token:this.accessToken}),Number(e.code)){case 1e3:this.changeState(l.CLOSED),this.emit("#closed",e);break;case 1001:case 1005:case 1006:case 1011:this.reconnect();break;case 1012:this.reconnect(5e3);break;case 1013:this.reconnect();break;case 1014:this.reconnect(5e3)}},u.onError=function(e){c.log.warning("on socket error",e,e.errMsg),this.emit("#error",e)},u.onMessage=function(e){var t=e.data;c.log.log("ws receive",t);var r=t.indexOf("=");if(r>0){var n=t.substring(0,r),s=JSON.parse(t.substring(r+1));this.receiveWsMsg(n,s)}},u.receiveWsMsg=function(e,t){"on-rtmp-conn-closed"===e?o.default.addEvent("AbnormalDisconnect",{event_reason:"on-rtmp-conn-closed",event_description:t.error}):"ping"===e?this.handlePing():"mute-tracks-res"===e?this.emit("#message",e,t):t.rpcid?this.emit("#message#"+t.rpcid,e,t):this.emit("#message",e,t)},u.send=function(e,t){if(void 0===t&&(t={}),this.ws){var r=e+"="+JSON.stringify(t);return c.log.log("ws send",r),this.ws.send(r)}},u.request=function(e,t){var r=this;return void 0===t&&(t={}),new Promise((function(n,s){t.rpcid||(t.rpcid=(0,i.rpcid)(),o.default.setRpcId(t.rpcid)),r.send(e,t).catch(s),c.log.log("send: "+e+JSON.stringify(t)),r.once("#message#"+t.rpcid,(function(e,t){c.log.log("recv:",e,t),0===t.code?n(t):s(t)}))}))},u.close=function(){this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this.ws&&this.ws.close()},u.handlePing=function(){var e=this;this._state===l.OPEN&&this.send("pong",{}),this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this.reconnectTimeoutID=setTimeout((function(){c.log.log("signaling: websocket heartbeat timeout"),e.emit("timeout","signaling: websocket heartbeat timeout"),e.reconnect()}),9e3)},u.changeState=function(e){o.default.addEvent("RoomStateChanged",{room_state:e}),c.log.log("RoomStateChanged",e),this._state=e},u.reconnect=function(e){var t=this;return void 0===e&&(e=1e3),this.reconnectTimeoutID&&clearTimeout(this.reconnectTimeoutID),this._state===l.CLOSED?(this.ws.silentClose(),this.emit("#error"),Promise.resolve()):(this.reconnectPromise||(void 0===this.reconnectTimeoutID&&(this.reconnectTimeoutID=setTimeout((function(){t.changeState(l.CLOSED),t.reconnectTimeoutID=void 0}),this.reconnectTimeout)),this.changeState(l.CONNECTING),this.emit("reconnecting"),c.log.log("signaling: websocket reconnecting"),this.reconnectPromise=(0,i.timeout)(e).then(this.init.bind(this)).then((function(e){return t.reconnectPromise=void 0,c.log.log("signaling: websocket reconnected"),e})).catch((function(e){if(t.reconnectPromise=void 0,e.code){if(10001!==e.code)return t.reconnect();t.changeState(l.CLOSED)}throw c.log.log("signaling: websocket reconnect fail",e),t.ws.close(),t.emit("@error",e),e}))),this.reconnectPromise)},u.sendAuth=function(){var e;return e=this.rtmptoken?{rtmptoken:this.rtmptoken}:{app:this.app,agent:"wechat miniprogram",roomtoken:this.accessToken,sdkversion:s.version,room:this.room,user:this.user,playerdata:this.userData},o.default.setSessionId(e.rtmptoken||e.roomtoken),this.request("auth",e)},u.sendCreateMergeJob=function(e){var t=Date.now();return this.request("create-merge-job",e).then((function(r){return o.default.addEvent("CreateMergeJob",{signal_take_time:Date.now()-t,id:e.id,result_code:r.code}),r}))},u.sendUpdateMergeTracks=function(e){return o.default.addEvent("UpdateMergeTracks",{id:e.id,add:(e.add||[]).map((function(e){return{track_id:e.trackid,x:e.x||0,y:e.y||0,w:e.w||0,h:e.h||0,z:e.z||0,stretchMode:e.stretchMode||0}})),remove:(e.remove||[]).map((function(e){return{track_id:e.trackid,x:e.x||0,y:e.y||0,w:e.w||0,h:e.h||0,z:e.z||0,stretchMode:e.stretchMode||0}}))}),this.request("update-merge-tracks",e)},u.sendStopMerge=function(e){return o.default.addEvent("StopMerge",{id:e}),this.request("stop-merge",{id:e})},u.sendSendMessage=function(e,t){var r={msgid:(0,i.rpcid)(),target:e,type:"normal",text:t};return this.request("send-message",r)},n}(n.EventEmitter);t.default=h},function(e,t){e.exports=require("fingerprintjs2")},function(e,t){e.exports=require("blueimp-md5")},function(e,t){e.exports=require("gzip-js")},function(e,t,r){"use strict";t.__esModule=!0,t.default=void 0;var n=r(2),s=r(0);function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a=function(e){var t,r;function n(t){var r;return(r=e.call(this)||this).socketTask=wx.connectSocket({url:t,success:function(e){s.log.log("success:"+JSON.stringify(e))},fail:function(e){s.log.warning("fail:"+JSON.stringify(e))}}),r.socketTask.onClose(r.emit.bind(i(r),"close")),r.socketTask.onError(r.emit.bind(i(r),"error")),r.socketTask.onMessage(r.emit.bind(i(r),"message")),r.socketTask.onOpen(r.emit.bind(i(r),"open")),r}r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,o(t,r);var a=n.prototype;return a.send=function(e){var t=this;return new Promise((function(r,n){try{t.socketTask.send({data:e,success:r,fail:n})}catch(e){n(e)}}))},a.close=function(){return this.socketTask.close({fail:function(e){return s.log.warning("close",e)}})},a.silentClose=function(){return this.removeAllListeners(),this.socketTask.close({fail:function(e){return s.log.warning("close",e)}})},n}(n.EventEmitter);t.default=a}]);
//# sourceMappingURL=index.js.map